name: Deploy Next.js with Docker

on:
  push:
    branches:
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # environment ì„¤ì •ì€ í•„ìš” ì‹œ ì‚¬ìš©
    environment: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}

    env:
      IMAGE_NAME: ${{ vars.IMAGE_NAME }}
      CONTAINER_NAME: "frontend-container"

    steps:
      # 1) ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2) Docker Buildx ì„¸íŒ…
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3) Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4) Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      - name: Build and Push Docker Image
        run: |
          echo "ğŸ”¹ Docker ì´ë¯¸ì§€ ë¹Œë“œ: $IMAGE_NAME"

          docker build -t "$IMAGE_NAME" \
            --build-arg NEXT_PUBLIC_KAKAO_NATIVE="${{ secrets.NEXT_PUBLIC_KAKAO_NATIVE }}" \
            --build-arg NEXT_PUBLIC_KAKAO_REST_API="${{ secrets.NEXT_PUBLIC_KAKAO_REST_API }}" \
            --build-arg NEXT_PUBLIC_KAKAO_JAVASCRIPT_API="${{ secrets.NEXT_PUBLIC_KAKAO_JAVASCRIPT_API }}" \
            --build-arg NEXT_PUBLIC_KAKAO_ADMIN_API="${{ secrets.NEXT_PUBLIC_KAKAO_ADMIN_API }}" \
            --build-arg NEXT_PUBLIC_API_SERVER="${{ secrets.NEXT_PUBLIC_API_SERVER }}" \
            --build-arg NEXT_PUBLIC_AI_SERVER="${{ secrets.NEXT_PUBLIC_AI_SERVER }}" \
            .

          docker push "$IMAGE_NAME"

      # 5) SSH í‚¤ ì €ì¥
      - name: Save SSH Key (PEM)
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem

      # 6) EC2ì— ë°°í¬
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.SERVER_IP }} "bash -s" <<EOF
            echo "ğŸ”¹ EC2 ì ‘ì† ì„±ê³µ. Docker ì»¨í…Œì´ë„ˆ ë°°í¬ ì‹œì‘..."
            echo "ğŸ”¹ ì‚¬ìš© ì¤‘ì¸ Docker ì´ë¯¸ì§€: ${IMAGE_NAME}"

            echo "ğŸ”¹ Docker Hub ë¡œê·¸ì¸"
            docker login -u '${{ secrets.DOCKER_USERNAME }}' -p '${{ secrets.DOCKER_PASSWORD }}'

            echo "ğŸ”¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ..."
            if [ "\$(docker ps -q -f name=${CONTAINER_NAME})" ]; then
              docker stop ${CONTAINER_NAME}
              docker rm ${CONTAINER_NAME}
            else
              echo "âš  ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì—†ìŒ"
            fi

            docker pull "${IMAGE_NAME}"

            docker run -d --name ${CONTAINER_NAME} -p 3000:3000 \
              --restart unless-stopped \
              "${IMAGE_NAME}"
          EOF